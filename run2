#!/bin/bash

# Function to check if a command exists
command_exists() {
    command -v "$1" &> /dev/null
}

# Step 1: Download the Guix Installer Script
echo "Downloading Guix installer script..."
if wget -q https://git.savannah.gnu.org/cgit/guix.git/plain/etc/guix-install.sh -O guix-install.sh; then
    echo "Guix installer script downloaded successfully."
else
    echo "Failed to download Guix installer script. Exiting."
    exit 1
fi

# Step 2: Run the Installer Script
echo "Running the Guix installer script..."
if bash guix-install.sh; then
    echo "Guix installed successfully."
else
    echo "Guix installation failed. Attempting to troubleshoot..."

    # Basic troubleshooting: check if required directories are missing
    if [ ! -d "/gnu" ]; then
        echo "Directory /gnu is missing. Creating it with sudo privileges..."
        sudo mkdir -p /gnu
    fi

    if [ ! -d "/var/guix" ]; then
        echo "Directory /var/guix is missing. Creating it with sudo privileges..."
        sudo mkdir -p /var/guix
    fi

    echo "Re-running Guix installer..."
    if ! bash guix-install.sh; then
        echo "Guix installation failed again. Please check the output above for errors."
        exit 1
    fi
fi

# Step 3: Add Guix to the PATH
echo "Configuring environment variables for Guix..."
SHELL_PROFILE="$HOME/.bashrc"
echo 'export PATH="$HOME/.config/guix/current/bin:$PATH"' >> "$SHELL_PROFILE"
source "$SHELL_PROFILE"

# Step 4: Verify the Installation
echo "Verifying Guix installation..."
if command_exists guix; then
    echo "Guix installed and accessible from the PATH."
else
    echo "Guix command not found in PATH. Attempting alternative setup..."

    # Add the Guix profile directly to PATH if it wasn't picked up
    export PATH="$HOME/.config/guix/current/bin:$PATH"
    echo 'export PATH="$HOME/.config/guix/current/bin:$PATH"' >> "$SHELL_PROFILE"
fi

# Step 5: Test Guix by Installing a Sample Package
echo "Testing Guix by installing the 'hello' package..."
if guix install hello -q; then
    echo "'hello' package installed successfully. Testing 'hello' command..."
    if hello &> /dev/null; then
        echo "Guix is set up correctly. Installation and setup were successful."
    else
        echo "'hello' package installation succeeded, but 'hello' command did not run. Please check Guix setup."
    fi
else
    echo "Failed to install 'hello' package with Guix. Please check Guix setup."
fi

# Clean up installer script
echo "Cleaning up..."
rm -f guix-install.sh

echo "Setup complete."
